<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Panel</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="admin.css">
</head>
<body>

<!-- Sidebar -->
<aside class="sidebar">
  <h2>ADMIN</h2>
  <nav>
    <button onclick="openPage('overview')">Overview</button>
    <button onclick="openPage('users')">Users</button>
    <button onclick="openPage('products')">Products</button>
    <button onclick="openPage('orders')">Orders</button>
    <button onclick="openPage('categories')">Categories</button>
    <button onclick="openPage('analytics')">Analytics</button>
    <button onclick="openPage('settings')">Settings</button>
    <button class="logout" onclick="logout()">Logout</button>
  </nav>
</aside>

<!-- Main -->
<main class="main">

  <!-- OVERVIEW -->
  <section id="overview" class="page active">
    <h1>Dashboard</h1>
    <div class="cards">
      <div class="card">Users<br><strong>0</strong></div>
      <div class="card">Products<br><strong>0</strong></div>
      <div class="card">Orders<br><strong>0</strong></div>
      <div class="card">Revenue<br><strong>₹0</strong></div>
    </div>
  </section>


  <section id="users" class="page">
  <h1>Users</h1>

  <div class="controls">
    <input
      type="text"
      id="searchInput"
      placeholder="Search by email"
      oninput="loadUsers(1)"
    />

    <select id="statusFilter" onchange="loadUsers(1)">
      <option value="all">All</option>
      <option value="active">Active</option>
      <option value="blocked">Blocked</option>
    </select>
  </div>

  <table>
    <thead>
      <tr>
        <th>Email</th>
        <th>Status</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="pagination">
    <button onclick="prevPage()">Prev</button>
    <span id="pageInfo"></span>
    <button onclick="nextPage()">Next</button>
  </div>
</section>


  <!-- PRODUCTS -->
<section id="products" class="tab hidden page">
  <h2>Products</h2>

  <button onclick="openAddProduct()">+ Add Product</button>
  <div class="controls">

  <input
    type="text"
    id="productSearch"
    placeholder="Search by name or category"
    oninput="loadProducts(1)"
  />

  <input type="number" id="minPrice" placeholder="Min ₹" />
  <input type="number" id="maxPrice" placeholder="Max ₹" />

  <select id="stockFilter" onchange="loadProducts(1)">
    <option value="">All Stock</option>
    <option value="in">In Stock</option>
    <option value="out">Out of Stock</option>
  </select>

  <select id="statusFilterProduct" onchange="loadProducts(1)">
    <option value="">All Status</option>
    <option value="active">Active</option>
    <option value="inactive">Inactive</option>
  </select>

  <button onclick="loadProducts(1)">Apply</button>

</div>


  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Price</th>
        <th>Stock</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="productsTable"></tbody>
  </table>

  <div class="pagination">
  <button onclick="productPage > 1 && loadProducts(productPage - 1)">
    Prev
  </button>
  <span id="productPageInfo"></span>
  <button onclick="productPage < productPages && loadProducts(productPage + 1)">
    Next
  </button>
</div>

</section>

  <!-- ORDERS -->
  <section id="orders" class="page">
    <h1>Orders</h1>
    <table>
      <thead>
        <tr>
          <th>Order ID</th>
          <th>User</th>
          <th>Status</th>
          <th>Update</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- CATEGORIES -->
  <section id="categories" class="page">
    <h1>Categories</h1>
    <input placeholder="New category">
    <button>Add</button>
    <ul class="list"></ul>
  </section>

  <!-- ANALYTICS -->
  <section id="analytics" class="page">
    <h1>Analytics</h1>
    <p>Graphs & charts will be added later</p>
  </section>

  <!-- SETTINGS -->
  <section id="settings" class="page">
    <h1>Settings</h1>
    <button>Maintenance Mode</button>
    <button>Manage Admins</button>
  </section>

</main>


  <!-- Add Product Modal -->
<div id="productModal" class="modal hidden">
  <div class="modal-content">
    
    <!-- Header -->
    <div class="modal-header">
      <h3>Add Product</h3>
      <span class="material-icons close-btn" onclick="closeProductModal()">close</span>
    </div>

    <!-- Form -->
    <form id="productForm" enctype="multipart/form-data">

      <input type="text" id="name" placeholder="Product Name" required>

      <textarea id="description" placeholder="Product Description" required></textarea>

      <input type="text" id="category" placeholder="Category (eg: Electronics, Fashion)" required>

      <div class="row">
        <input type="number" id="price" placeholder="Price ₹" required>
        <input type="number" id="discount" placeholder="Discount %" value="0">
      </div>

      <input type="number" id="stock" placeholder="Stock Quantity" required>

      <select id="status">
        <option value="true">Active</option>
        <option value="false">Inactive</option>
      </select>

      <!-- Image -->
      <label class="image-upload">
        <span class="material-icons">upload</span>
        Upload Image
        <input type="file" id="image" accept="image/*" hidden>
      </label>

      <img id="preview" class="preview hidden">

      <button type="submit" class="submit-btn">Add Product</button>
    </form>
  </div>
</div>


<script>
  
const API = "https://my-store-w94t.onrender.com/api/admin";
const token = localStorage.getItem("adminToken");
let editingProductId = null;


let currentPage = 1;
let totalPages = 1;

if (!token) {
  window.location.href = "admin-login.html";
}

function openPage(pageId) {
  document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
  document.getElementById(pageId).classList.add("active");

  if (pageId === "users") loadUsers(1);
  if (pageId === "products") loadProducts();
}

function logout() {
  localStorage.removeItem("adminToken");
  window.location.href = "admin-login.html";
}

  /* Load users count */
async function loadUserCount() {
  const res = await fetch(`${API}/users/count`, {
    headers: { Authorization: `Bearer ${token}` }
  });
  const data = await res.json();
  document.querySelector(".card strong").innerText = data.count;
}

/* LOAD USERS */
async function loadUsers(page = 1) {
  currentPage = page;

  const search = document.getElementById("searchInput").value;
  const status = document.getElementById("statusFilter").value;

  const res = await fetch(
    `${API}/users?page=${page}&limit=5&search=${search}&status=${status}`,
    {
      headers: {
        Authorization: `Bearer ${token}`
      }
    }
  );

  const data = await res.json();
  totalPages = data.pages;

  const tbody = document.querySelector("#users tbody");
  tbody.innerHTML = "";

  data.users.forEach(user => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${user.email}</td>
      <td>${user.isBlocked ? "Blocked" : "Active"}</td>
      <td>
        <button onclick="toggleBlock('${user._id}')">
          ${user.isBlocked ? "Unblock" : "Block"}
        </button>
        <button onclick="deleteUser('${user._id}')">Delete</button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  document.getElementById("pageInfo").innerText =
    `Page ${currentPage} of ${totalPages}`;
}

/* PAGINATION */
function nextPage() {
  if (currentPage < totalPages) loadUsers(currentPage + 1);
}

function prevPage() {
  if (currentPage > 1) loadUsers(currentPage - 1);
}

/* BLOCK / UNBLOCK */
async function toggleBlock(id) {
  await fetch(`${API}/users/${id}/block`, {
    method: "PATCH",
    headers: {
      Authorization: `Bearer ${token}`
    }
  });

  loadUsers(currentPage);
}

/* DELETE USER */
async function deleteUser(id) {
  if (!confirm("Delete this user?")) return;

  await fetch(`${API}/users/${id}`, {
    method: "DELETE",
    headers: {
      Authorization: `Bearer ${token}`
    }
  });

  loadUsers(currentPage);
}

  
let productPage = 1;
let productPages = 1;

function loadProducts(page = 1) {
  productPage = page;

  const search = document.getElementById("productSearch").value;
  const minPrice = document.getElementById("minPrice").value;
  const maxPrice = document.getElementById("maxPrice").value;
  const stock = document.getElementById("stockFilter").value;
  const status = document.getElementById("statusFilterProduct").value;

  const params = new URLSearchParams({
    search,
    minPrice,
    maxPrice,
    stock,
    status,
    page,
    limit: 5
  });


  fetch(`https://my-store-w94t.onrender.com/api/admin/products?${params}`, {
  headers: {
    Authorization: "Bearer " + localStorage.getItem("adminToken")
  }
})
  .then(res => res.json())
  .then(data => {
    const table = document.getElementById("productsTable");
    table.innerHTML = "";

    if (!data.products.length) {
      table.innerHTML = `<tr><td colspan="5">No products found</td></tr>`;
      return;
    }

    productPages = data.pages;

    data.products.forEach(p => {
      table.innerHTML += `
        <tr>
          <td>${p.name}</td>
          <td>₹${p.price}</td>
          <td>${p.stock}</td>
          <td>${p.isActive ? "Active" : "Inactive"}</td>
          <td>
            <button onclick="openEditProduct('${encodeURIComponent(JSON.stringify(p))}')">Edit</button>
            <button onclick="toggleProduct('${p._id}')">Toggle</button>
            <button onclick="deleteProduct('${p._id}')">Delete</button>
          </td>
        </tr>
      `;
    });

    document.getElementById("productPageInfo").innerText =
      `Page ${productPage} of ${productPages}`;
  })
  .catch(err => {
    console.error(err);
    alert("Admin session expired. Login again.");
    window.location.href = "admin-login.html";
  });


//   fetch(`https://my-store-w94t.onrender.com/api/admin/products?${params}`, {
//     headers: {
//       Authorization: "Bearer " + localStorage.getItem("adminToken")
//     }
//   })
//     .then(res => res.json())
//     .then(data => {
//       const table = document.getElementById("productsTable");
//       table.innerHTML = "";

//       if (!data.products.length) {
//         table.innerHTML = `<tr><td colspan="5">No products found</td></tr>`;
//         return;
//       }

//       productPages = data.pages;

//       data.products.forEach(p => {
//         table.innerHTML += `
//           <tr>
//             <td>${p.name}</td>
//             <td>₹${p.price}</td>
//             <td>${p.stock}</td>
//             <td>${p.isActive ? "Active" : "Inactive"}</td>
//             <td>
//               <button onclick="openEditProduct('${encodeURIComponent(JSON.stringify(p))}')">Edit</button>
//               <button onclick="toggleProduct('${p._id}')">Toggle</button>
//               <button onclick="deleteProduct('${p._id}')">Delete</button>
//             </td>
//           </tr>
//         `;
//         document.getElementById("productPageInfo").innerText =
//   `Page ${productPage} of ${productPages}`;

//       });
//     });
// }

//   .catch(err => {
//     console.error(err);
//     alert("Admin session expired. Login again.");
//     window.location.href = "admin-login.html";
//   });
// }


  function toggleProduct(id) {
  fetch(`https://my-store-w94t.onrender.com/api/admin/products/${id}/status`, {
    method: "PATCH",
    headers: {
      Authorization: "Bearer " + localStorage.getItem("adminToken")
    }
  }).then(loadProducts);
}

function deleteProduct(id) {
  if (!confirm("Delete this product?")) return;

  fetch(`https://my-store-w94t.onrender.com/api/admin/products/${id}`, {
    method: "DELETE",
    headers: {
      Authorization: "Bearer " + localStorage.getItem("adminToken")
    }
  }).then(loadProducts);
}


function openAddProduct() {
  // editingProductId = null;
  // document.getElementById("productForm").reset();
  // document.querySelector(".submit-btn").innerText = "Add Product";
  // document.getElementById("preview").classList.add("hidden");
  document.getElementById("productModal").classList.remove("hidden");
}

function closeProductModal() {
  document.getElementById("productModal").classList.add("hidden");
}

  document.getElementById("image").addEventListener("change", e => {
  const file = e.target.files[0];
  const preview = document.getElementById("preview");

  preview.src = URL.createObjectURL(file);
  preview.classList.remove("hidden");
});


  function openEditProduct(productStr) {
  const product = JSON.parse(decodeURIComponent(productStr));
  editingProductId = product._id;

  document.getElementById("name").value = product.name;
  document.getElementById("description").value = product.description;
  document.getElementById("category").value = product.category;
  document.getElementById("price").value = product.price;
  document.getElementById("discount").value = product.discount || 0;
  document.getElementById("stock").value = product.stock;
  document.getElementById("status").value = product.isActive;

if (product.image && product.image.url) {
  const preview = document.getElementById("preview");
  preview.src = product.image.url;
  preview.classList.remove("hidden");
}

  document.querySelector(".submit-btn").innerText = "Update Product";
  openAddProduct();
}


  document.getElementById("productForm").addEventListener("submit", async e => {
  e.preventDefault();

  const formData = new FormData();
  formData.append("name", document.getElementById("name").value);
  formData.append("description", document.getElementById("description").value);
  formData.append("category", document.getElementById("category").value);
  formData.append("price", document.getElementById("price").value);
  formData.append("discount", document.getElementById("discount").value);
  formData.append("stock", document.getElementById("stock").value);
  formData.append("isActive", document.getElementById("status").value);

  const imageInput = document.getElementById("image");
  if (imageInput.files[0]) {
    formData.append("image", imageInput.files[0]);
  }

  const url = editingProductId
    ? `https://my-store-w94t.onrender.com/api/admin/products/${editingProductId}`
    : `https://my-store-w94t.onrender.com/api/admin/products`;

  const method = editingProductId ? "PUT" : "POST";

  const res = await fetch(url, {
    method,
    headers: {
      Authorization: "Bearer " + localStorage.getItem("adminToken")
    },
    body: formData
  });

  if (res.ok) {
    editingProductId = null;
    document.querySelector(".submit-btn").innerText = "Add Product";
    closeProductModal();
    loadProducts();
    e.target.reset();
  }
});


/* Initial load */
loadUserCount();
loadProducts();



</script>
</body>
</html>
