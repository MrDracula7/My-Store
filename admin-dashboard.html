<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Panel</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="admin.css">
</head>
<body>

<!-- Sidebar -->
<aside class="sidebar">
  <h2>ADMIN</h2>
  <nav>
    <button onclick="openPage('overview')">Overview</button>
    <button onclick="openPage('users')">Users</button>
    <button onclick="openPage('products')">Products</button>
    <button onclick="openPage('orders')">Orders</button>
    <button onclick="openPage('categories')">Categories</button>
    <button onclick="openPage('analytics')">Analytics</button>
    <button onclick="openPage('settings')">Settings</button>
    <button class="logout" onclick="logout()">Logout</button>
  </nav>
</aside>

<!-- Main -->
<main class="main">

  <!-- OVERVIEW -->
  <section id="overview" class="page active">
    <h1>Dashboard</h1>
    <div class="cards">
      <div class="card">Users<br><strong>0</strong></div>
      <div class="card">Products<br><strong>0</strong></div>
      <div class="card">Orders<br><strong>0</strong></div>
      <div class="card">Revenue<br><strong>₹0</strong></div>
    </div>
  </section>


  <section id="users" class="page">
  <h1>Users</h1>

  <div class="controls">
    <input
      type="text"
      id="searchInput"
      placeholder="Search by email"
      oninput="loadUsers(1)"
    />

    <select id="statusFilter" onchange="loadUsers(1)">
      <option value="all">All</option>
      <option value="active">Active</option>
      <option value="blocked">Blocked</option>
    </select>
  </div>

  <table>
    <thead>
      <tr>
        <th>Email</th>
        <th>Status</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="pagination">
    <button onclick="prevPage()">Prev</button>
    <span id="pageInfo"></span>
    <button onclick="nextPage()">Next</button>
  </div>
</section>


  <!-- PRODUCTS -->
<section id="products" class="tab hidden page">
  <h2>Products</h2>

  <button onclick="openAddProduct()">+ Add Product</button>

  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Price</th>
        <th>Stock</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="productsTable"></tbody>
  </table>
</section>

  <!-- ORDERS -->
  <section id="orders" class="page">
    <h1>Orders</h1>
    <table>
      <thead>
        <tr>
          <th>Order ID</th>
          <th>User</th>
          <th>Status</th>
          <th>Update</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- CATEGORIES -->
  <section id="categories" class="page">
    <h1>Categories</h1>
    <input placeholder="New category">
    <button>Add</button>
    <ul class="list"></ul>
  </section>

  <!-- ANALYTICS -->
  <section id="analytics" class="page">
    <h1>Analytics</h1>
    <p>Graphs & charts will be added later</p>
  </section>

  <!-- SETTINGS -->
  <section id="settings" class="page">
    <h1>Settings</h1>
    <button>Maintenance Mode</button>
    <button>Manage Admins</button>
  </section>

</main>


  <!-- Add Product Modal -->
<div id="productModal" class="modal hidden">
  <div class="modal-content">
    
    <!-- Header -->
    <div class="modal-header">
      <h3>Add Product</h3>
      <span class="material-icons close-btn" onclick="closeProductModal()">close</span>
    </div>

    <!-- Form -->
    <form id="productForm" enctype="multipart/form-data">

      <input type="text" id="name" placeholder="Product Name" required>

      <textarea id="description" placeholder="Product Description" required></textarea>

      <input type="text" id="category" placeholder="Category (eg: Electronics, Fashion)" required>

      <div class="row">
        <input type="number" id="price" placeholder="Price ₹" required>
        <input type="number" id="discount" placeholder="Discount %" value="0">
      </div>

      <input type="number" id="stock" placeholder="Stock Quantity" required>

      <select id="status">
        <option value="true">Active</option>
        <option value="false">Inactive</option>
      </select>

      <!-- Image -->
      <label class="image-upload">
        <span class="material-icons">upload</span>
        Upload Image
        <input type="file" id="image" accept="image/*" hidden>
      </label>

      <img id="preview" class="preview hidden">

      <button type="submit" class="submit-btn">Add Product</button>
    </form>
  </div>
</div>


<script>
  
const API = "https://my-store-w94t.onrender.com/api/admin";
const token = localStorage.getItem("adminToken");

let currentPage = 1;
let totalPages = 1;

if (!token) {
  window.location.href = "admin-login.html";
}

function openPage(pageId) {
  document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
  document.getElementById(pageId).classList.add("active");

  if (pageId === "users") loadUsers(1);
}

function logout() {
  localStorage.removeItem("adminToken");
  window.location.href = "admin-login.html";
}

  /* Load users count */
async function loadUserCount() {
  const res = await fetch(`${API}/users/count`, {
    headers: { Authorization: `Bearer ${token}` }
  });
  const data = await res.json();
  document.querySelector(".card strong").innerText = data.count;
}

/* LOAD USERS */
async function loadUsers(page = 1) {
  currentPage = page;

  const search = document.getElementById("searchInput").value;
  const status = document.getElementById("statusFilter").value;

  const res = await fetch(
    `${API}/users?page=${page}&limit=5&search=${search}&status=${status}`,
    {
      headers: {
        Authorization: `Bearer ${token}`
      }
    }
  );

  const data = await res.json();
  totalPages = data.pages;

  const tbody = document.querySelector("#users tbody");
  tbody.innerHTML = "";

  data.users.forEach(user => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${user.email}</td>
      <td>${user.isBlocked ? "Blocked" : "Active"}</td>
      <td>
        <button onclick="toggleBlock('${user._id}')">
          ${user.isBlocked ? "Unblock" : "Block"}
        </button>
        <button onclick="deleteUser('${user._id}')">Delete</button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  document.getElementById("pageInfo").innerText =
    `Page ${currentPage} of ${totalPages}`;
}

/* PAGINATION */
function nextPage() {
  if (currentPage < totalPages) loadUsers(currentPage + 1);
}

function prevPage() {
  if (currentPage > 1) loadUsers(currentPage - 1);
}

/* BLOCK / UNBLOCK */
async function toggleBlock(id) {
  await fetch(`${API}/users/${id}/block`, {
    method: "PATCH",
    headers: {
      Authorization: `Bearer ${token}`
    }
  });

  loadUsers(currentPage);
}

/* DELETE USER */
async function deleteUser(id) {
  if (!confirm("Delete this user?")) return;

  await fetch(`${API}/users/${id}`, {
    method: "DELETE",
    headers: {
      Authorization: `Bearer ${token}`
    }
  });

  loadUsers(currentPage);
}

function loadProducts() {
  fetch("https://my-store-w94t.onrender.com/api/admin/products", {
    headers: {
      Authorization: "Bearer " + localStorage.getItem("adminToken")
    }
  })
  .then(res => res.json())
  .then(products => {
    const table = document.getElementById("productsTable");
    table.innerHTML = "";

    products.forEach(p => {
      table.innerHTML += `
        <tr>
          <td>${p.name}</td>
          <td>₹${p.price}</td>
          <td>${p.stock}</td>
          <td>${p.isActive ? "Active" : "Inactive"}</td>
          <td>
            <button onclick="toggleProduct('${p._id}')">Toggle</button>
            <button onclick="deleteProduct('${p._id}')">Delete</button>
          </td>
        </tr>
      `;
    });
  });
}

  function toggleProduct(id) {
  fetch(`https://my-store-w94t.onrender.com/api/admin/products/${id}/status`, {
    method: "PATCH",
    headers: {
      Authorization: "Bearer " + localStorage.getItem("adminToken")
    }
  }).then(loadProducts);
}

function deleteProduct(id) {
  if (!confirm("Delete this product?")) return;

  fetch(`https://my-store-w94t.onrender.com/api/admin/products/${id}`, {
    method: "DELETE",
    headers: {
      Authorization: "Bearer " + localStorage.getItem("adminToken")
    }
  }).then(loadProducts);
}


function openAddProduct() {
  document.getElementById("productModal").classList.remove("hidden");
}

function closeProductModal() {
  document.getElementById("productModal").classList.add("hidden");
}

  document.getElementById("image").addEventListener("change", e => {
  const file = e.target.files[0];
  const preview = document.getElementById("preview");

  preview.src = URL.createObjectURL(file);
  preview.classList.remove("hidden");
});



// document.getElementById("productForm").addEventListener("submit", async e => {
//   e.preventDefault();

//   const formData = new FormData();
//   formData.append("name", name.value);
//   formData.append("description", description.value);
//   formData.append("category", category.value);
//   formData.append("price", price.value);
//   formData.append("discount", discount.value);
//   formData.append("stock", stock.value);
//   formData.append("isActive", status.value);
//   formData.append("image", image.files[0]);

//   const res = await fetch("https://my-store-w94t.onrender.com/api/admin/products", {
//     method: "POST",
//     headers: {
//       Authorization: "Bearer " + localStorage.getItem("adminToken")
//     },
//     body: formData
//   });

//   if (res.ok) {
//     closeProductModal();
//     loadProducts();
//     e.target.reset();
//   }
// });



document.getElementById("productForm").addEventListener("submit", async e => {
  e.preventDefault();

  const formData = new FormData();

  formData.append("name", document.getElementById("name").value);
  formData.append("description", document.getElementById("description").value);
  formData.append("category", document.getElementById("category").value);
  formData.append("price", document.getElementById("price").value);
  formData.append("discount", document.getElementById("discount").value);
  formData.append("stock", document.getElementById("stock").value);
  formData.append("isActive", document.getElementById("status").value);
  formData.append("image", document.getElementById("image").files[0]);

  const res = await fetch(
    "https://my-store-w94t.onrender.com/api/admin/products",
    {
      method: "POST",
      headers: {
        Authorization: "Bearer " + localStorage.getItem("adminToken")
      },
      body: formData
    }
  );

  if (res.ok) {
    closeProductModal();
    loadProducts();
    e.target.reset();
  }
});



  
/* Initial load */
loadUserCount();


</script>
</body>
</html>
